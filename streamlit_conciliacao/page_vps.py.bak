# -*- coding: utf-8 -*-
"""
P√°gina Streamlit para concilia√ß√£o cont√°bil da VPS METAL√öRGICA
"""

from __future__ import annotations

import sys
import os
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

import io
from io import BytesIO
from pathlib import Path
from typing import Any, Dict, Optional, List

import pandas as pd
import streamlit as st

from vps.conciliador_vps import conciliar_vps
from vps.utils_vps import (
    carregar_contas_contabeis,
    carregar_lancamentos,
    carregar_extratos,
    fmt_valor,
)


# ============== Helpers locais (UI) ==============
def _fmt_val(v: float) -> str:
    return f"{float(v):0.2f}".replace(".", ",")


# ============== PLANILHAS EXEMPLO ==============
def _gerar_exemplo_contas_contabeis() -> bytes:
    """Gera planilha exemplo de Contas Cont√°beis com 4 abas."""
    # Aba RELATORIO FINANCEIRO - fornecedores
    df_financeiro = pd.DataFrame({
        'LANCAMENTOS': ['FORNECEDOR ABC LTDA', 'DISTRIBUIDORA XYZ', 'ATACADO NORTE', 'SERVICOS GERAIS'],
        'CONTAS': [101, 102, 103, 104],
        'HISTORICO': [34, 34, 34, 34],
    })
    # Aba SICOOB - cadastro por hist√≥rico
    df_sicoob = pd.DataFrame({
        'LANCAMENTOS': ['TARIFA MENSAL', 'IOF', 'PIX RECEBIDO', 'TED RECEBIDA'],
        'CONTAS': [170, 171, 5, 5],
        'Historico': [11, 11, 2, 2],
    })
    # Aba BRADESCO - cadastro por hist√≥rico
    df_bradesco = pd.DataFrame({
        'LANCAMENTOS': ['TARIFA PACOTE', 'DEB PACOTE SERVICOS', 'PIX RECEBIDO', 'DEPOSITO'],
        'CONTAS': [170, 170, 5, 5],
        'Historico': [11, 11, 2, 9],
    })
    # Aba SICREDI - cadastro por hist√≥rico
    df_sicredi = pd.DataFrame({
        'LANCAMENTOS': ['TARIFA MENSAL', 'TAC', 'TED RECEBIDA', 'PIX RECEBIDO'],
        'CONTAS': [170, 170, 5, 5],
        'Historico': [11, 11, 2, 2],
    })
    buffer = BytesIO()
    with pd.ExcelWriter(buffer, engine='openpyxl') as writer:
        df_financeiro.to_excel(writer, index=False, sheet_name='RELATORIO FINANCEIRO')
        df_sicoob.to_excel(writer, index=False, sheet_name='SICOOB')
        df_bradesco.to_excel(writer, index=False, sheet_name='BRADESCO')
        df_sicredi.to_excel(writer, index=False, sheet_name='SICREDI')
    return buffer.getvalue()


def _gerar_exemplo_lancamentos() -> bytes:
    """Gera planilha exemplo de Lan√ßamentos."""
    df = pd.DataFrame({
        'FORNECEDOR': ['FORNECEDOR ABC LTDA', 'DISTRIBUIDORA XYZ', 'ATACADO NORTE'],
        'NF': ['12345', '67890', '11111'],
        'Vencimento ': ['01/11/2025', '02/11/2025', '03/11/2025'],
        'Valor R$': [1500.00, 2300.50, 890.00],
        'Juros e multas': [0.00, 15.50, 0.00],
        'Valor pago': [1500.00, 2316.00, 890.00],
        'Forma de Pagamento ': ['PIX', 'BOLETO', 'PIX'],
        'Data de \npagamento': ['01/11/2025', '02/11/2025', '03/11/2025'],
        'PAGAMENTO': ['SICOOB', 'BRADESCO', 'SICREDI'],
    })
    buffer = BytesIO()
    with pd.ExcelWriter(buffer, engine='openpyxl') as writer:
        df.to_excel(writer, index=False, sheet_name='LANCAMENTOS')
    return buffer.getvalue()


def _gerar_exemplo_extratos() -> bytes:
    """Gera planilha exemplo de Extratos."""
    df = pd.DataFrame({
        'DATA': ['01/11/2025', '02/11/2025', '03/11/2025', '04/11/2025', '05/11/2025'],
        'HISTORICO': ['PIX ENVIADO FORNECEDOR ABC', 'PAG BOLETO DISTRIBUIDORA', 'TED ENVIADA ATACADO', 'TARIFA PACOTE SERVICOS', 'PIX RECEBIDO CLIENTE'],
        'VALOR': ['1.500,00D', '2.316,00D', '890,00D', '45,00D', '800,00C'],
    })
    buffer = BytesIO()
    with pd.ExcelWriter(buffer, engine='openpyxl') as writer:
        df.to_excel(writer, index=False, sheet_name='EXTRATOS')
    return buffer.getvalue()


# ============== PAGINA VPS ==============
def mostrar_pagina_vps():
    """Renderiza a p√°gina de concilia√ß√£o da VPS METAL√öRGICA."""

    st.title("üè≠ Concilia√ß√£o Cont√°bil - VPS METAL√öRGICA")
    st.markdown("**VPS METAL√öRGICA**")
    st.divider()

    # ==========================================================================
    # TABS PRINCIPAIS
    # ==========================================================================
    tabs = st.tabs(["üì§ Upload Arquivos", "üëÅÔ∏è Pr√©-visualiza√ß√£o", "üîÑ Concilia√ß√£o", "üìä Resultado", "üíæ Export CSV", "‚ö†Ô∏è N√£o Classificados"])

    # ==========================================================================
    # ABA 0 - UPLOAD DE ARQUIVOS
    # ==========================================================================
    with tabs[0]:
        st.header("üì§ Upload de Arquivos")
        st.markdown("Fa√ßa o upload dos arquivos necess√°rios para a concilia√ß√£o.")
        st.divider()

        # Arquivos Base
        st.subheader("üìÅ Arquivos Base")
        col1, col2 = st.columns(2)

        with col1:
            st.markdown("**Contas Cont√°beis**")
            st.caption("Planilha com as abas: RELATORIO FINANCEIRO, SICOOB, BRADESCO, SICREDI")
            contas_file = st.file_uploader(
                "Contas Cont√°beis.xlsx",
                type=["xlsx"],
                key="vps_contas",
                help="Planilha com mapeamento de fornecedores e hist√≥ricos banc√°rios para contas cont√°beis"
            )
            st.download_button(
                "üì• Baixar Exemplo",
                data=_gerar_exemplo_contas_contabeis(),
                file_name="exemplo_contas_contabeis_vps.xlsx",
                mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
            )

        with col2:
            st.markdown("**Lan√ßamentos**")
            st.caption("Planilha financeira com os pagamentos realizados")
            lancamentos_file = st.file_uploader(
                "Lan√ßamentos.xlsx",
                type=["xlsx"],
                key="vps_lancamentos",
                help="Planilha com fornecedor, NF, valores, datas e banco de pagamento"
            )
            st.download_button(
                "üì• Baixar Exemplo",
                data=_gerar_exemplo_lancamentos(),
                file_name="exemplo_lancamentos_vps.xlsx",
                mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
            )

        st.divider()

        # Extratos
        st.subheader("üè¶ Extratos Banc√°rios")
        st.markdown("**Extrato Consolidado**")
        st.caption("Planilha √∫nica com todas as movimenta√ß√µes dos bancos (SICOOB, BRADESCO, SICREDI)")
        extratos_file = st.file_uploader(
            "Extratos.xlsx",
            type=["xlsx"],
            key="vps_extratos",
            help="Planilha com Data, Hist√≥rico e Valor (formato C/D ou +/-)"
        )
        st.download_button(
            "üì• Baixar Exemplo",
            data=_gerar_exemplo_extratos(),
            file_name="exemplo_extratos_vps.xlsx",
            mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
        )

        st.divider()

        # Bot√£o carregar
        if st.button("‚úÖ Carregar Arquivos", type="primary", use_container_width=True):
            if not contas_file:
                st.error("‚ùå Arquivo de Contas Cont√°beis √© obrigat√≥rio!")
            elif not lancamentos_file:
                st.error("‚ùå Arquivo de Lan√ßamentos √© obrigat√≥rio!")
            elif not extratos_file:
                st.error("‚ùå Arquivo de Extratos √© obrigat√≥rio!")
            else:
                with st.spinner("Carregando arquivos..."):
                    try:
                        # Carrega contas cont√°beis
                        contas = carregar_contas_contabeis(contas_file)
                        st.session_state['vps_contas'] = contas

                        # Carrega lan√ßamentos
                        df_lancamentos = carregar_lancamentos(lancamentos_file)
                        st.session_state['vps_lancamentos'] = df_lancamentos

                        # Carrega extratos
                        df_extratos = carregar_extratos(extratos_file)
                        st.session_state['vps_extratos'] = df_extratos

                        st.success("‚úÖ Arquivos carregados com sucesso!")
                        st.info(f"üìä {len(df_lancamentos)} lan√ßamentos e {len(df_extratos)} movimenta√ß√µes de extrato carregadas.")

                    except Exception as e:
                        st.error(f"‚ùå Erro ao carregar arquivos: {str(e)}")

    # ==========================================================================
    # ABA 1 - PR√â-VISUALIZA√á√ÉO
    # ==========================================================================
    with tabs[1]:
        st.header("üëÅÔ∏è Pr√©-visualiza√ß√£o dos Dados")

        if 'vps_lancamentos' not in st.session_state:
            st.warning("‚ö†Ô∏è Carregue os arquivos primeiro na aba 'Upload Arquivos'")
        else:
            # Lan√ßamentos
            st.subheader("üìã Lan√ßamentos (Pagamentos)")
            df_lanc = st.session_state['vps_lancamentos']
            st.dataframe(df_lanc.head(20), use_container_width=True)
            st.caption(f"Total: {len(df_lanc)} lan√ßamentos")

            st.divider()

            # Extratos
            st.subheader("üè¶ Extratos Banc√°rios")
            df_ext = st.session_state['vps_extratos']
            st.dataframe(df_ext.head(20), use_container_width=True)
            st.caption(f"Total: {len(df_ext)} movimenta√ß√µes")

            st.divider()

            # Contas Cont√°beis
            st.subheader("üìö Contas Cont√°beis")
            contas = st.session_state['vps_contas']

            for aba_nome, df_aba in contas.items():
                with st.expander(f"Aba: {aba_nome}"):
                    st.dataframe(df_aba, use_container_width=True)
                    st.caption(f"Total: {len(df_aba)} registros")

    # ==========================================================================
    # ABA 2 - CONCILIA√á√ÉO
    # ==========================================================================
    with tabs[2]:
        st.header("üîÑ Executar Concilia√ß√£o")

        if 'vps_lancamentos' not in st.session_state:
            st.warning("‚ö†Ô∏è Carregue os arquivos primeiro na aba 'Upload Arquivos'")
        else:
            st.markdown("""
            **Processo de Concilia√ß√£o:**
            1. Confronta lan√ßamentos da planilha financeira com extratos banc√°rios
            2. Identifica fornecedores, bancos, datas e valores
            3. Classifica contas cont√°beis e hist√≥ricos
            4. Gera lan√ßamentos simples (1 d√©bito x 1 cr√©dito) ou compostos (com juros/multas)
            5. Processa movimenta√ß√µes n√£o conciliadas do extrato
            """)

            st.divider()

            if st.button("üöÄ Iniciar Concilia√ß√£o", type="primary", use_container_width=True):
                with st.spinner("Executando concilia√ß√£o..."):
                    try:
                        df_lancamentos = st.session_state['vps_lancamentos'].copy()
                        df_extratos = st.session_state['vps_extratos'].copy()
                        contas = st.session_state['vps_contas']

                        # Executa concilia√ß√£o
                        df_resultado, stats = conciliar_vps(df_lancamentos, df_extratos, contas)

                        # Salva resultados
                        st.session_state['vps_resultado'] = df_resultado
                        st.session_state['vps_stats'] = stats

                        st.success("‚úÖ Concilia√ß√£o conclu√≠da!")

                        # Exibe estat√≠sticas
                        col1, col2, col3 = st.columns(3)
                        with col1:
                            st.metric("Lan√ßamentos Processados", stats['total_lancamentos'])
                            st.metric("Conciliados", stats['conciliados_lancamento'])
                        with col2:
                            st.metric("Extratos Processados", stats['total_extrato'])
                            st.metric("Conciliados", stats['conciliados_extrato'])
                        with col3:
                            st.metric("N√£o Classificados", stats['nao_classificados'])
                            st.metric("Valor Total", f"R$ {_fmt_val(stats['valor_total_lancamentos'])}")

                    except Exception as e:
                        st.error(f"‚ùå Erro na concilia√ß√£o: {str(e)}")
                        import traceback
                        st.code(traceback.format_exc())

    # ==========================================================================
    # ABA 3 - RESULTADO
    # ==========================================================================
    with tabs[3]:
        st.header("üìä Resultado da Concilia√ß√£o")

        if 'vps_resultado' not in st.session_state:
            st.warning("‚ö†Ô∏è Execute a concilia√ß√£o primeiro na aba 'Concilia√ß√£o'")
        else:
            df_resultado = st.session_state['vps_resultado']
            stats = st.session_state['vps_stats']

            # Estat√≠sticas
            st.subheader("üìà Estat√≠sticas")
            col1, col2, col3, col4 = st.columns(4)
            with col1:
                st.metric("Total de Lan√ßamentos", len(df_resultado))
            with col2:
                ok = len(df_resultado[df_resultado.get('STATUS', 'OK') == 'OK'])
                st.metric("Classificados", ok)
            with col3:
                nao_class = stats['nao_classificados']
                st.metric("N√£o Classificados", nao_class)
            with col4:
                st.metric("Taxa de Sucesso", f"{(ok/(len(df_resultado)) * 100):.1f}%" if len(df_resultado) > 0 else "0%")

            st.divider()

            # Visualiza√ß√£o dos lan√ßamentos
            st.subheader("üìã Lan√ßamentos Gerados")

            # Filtro
            filtro = st.radio("Filtrar por:", ["Todos", "Classificados", "N√£o Classificados"], horizontal=True)

            if filtro == "Classificados":
                df_exibir = df_resultado[df_resultado.get('STATUS', 'OK') == 'OK']
            elif filtro == "N√£o Classificados":
                df_exibir = df_resultado[df_resultado.get('STATUS', 'OK') == 'NAO_CLASSIFICADO']
            else:
                df_exibir = df_resultado

            # Exibe tabela
            st.dataframe(df_exibir, use_container_width=True, height=400)
            st.caption(f"Exibindo {len(df_exibir)} de {len(df_resultado)} lan√ßamentos")

    # ==========================================================================
    # ABA 4 - EXPORT CSV
    # ==========================================================================
    with tabs[4]:
        st.header("üíæ Exportar CSV Padronizado")

        if 'vps_resultado' not in st.session_state:
            st.warning("‚ö†Ô∏è Execute a concilia√ß√£o primeiro")
        else:
            df_resultado = st.session_state['vps_resultado']
            stats = st.session_state['vps_stats']

            if stats['nao_classificados'] > 0:
                st.error(f"‚ùå Existem {stats['nao_classificados']} lan√ßamentos n√£o classificados!")
                st.warning("‚ö†Ô∏è Cadastre os fornecedores/hist√≥ricos faltantes na planilha de Contas Cont√°beis e refa√ßa a concilia√ß√£o.")
            else:
                st.success("‚úÖ Todos os lan√ßamentos foram classificados!")

                # Prepara CSV
                df_csv = df_resultado.copy()

                # Remove colunas extras (mant√©m apenas formato padr√£o)
                colunas_padrao = ['DATA', 'COD_CONTA_DEBITO', 'COD_CONTA_CREDITO', 'VALOR', 'COD_HISTORICO', 'COMPLEMENTO', 'INICIA_LOTE']
                df_csv = df_csv[[c for c in colunas_padrao if c in df_csv.columns]]

                # Remove linhas com STATUS != OK (se existir)
                if 'STATUS' in df_resultado.columns:
                    df_csv = df_resultado[df_resultado['STATUS'] == 'OK'][colunas_padrao]

                # Converte para CSV
                csv_buffer = io.StringIO()
                df_csv.to_csv(csv_buffer, index=False, sep=';', encoding='utf-8-sig')
                csv_data = csv_buffer.getvalue()

                # Preview
                st.subheader("üëÅÔ∏è Preview do CSV")
                st.dataframe(df_csv.head(20), use_container_width=True)
                st.caption(f"Total: {len(df_csv)} lan√ßamentos no CSV")

                st.divider()

                # Download
                col1, col2, col3 = st.columns([1, 2, 1])
                with col2:
                    st.download_button(
                        label="üì• Baixar CSV Padronizado",
                        data=csv_data,
                        file_name=f"vps_contabilizacao_{pd.Timestamp.now().strftime('%Y%m%d_%H%M%S')}.csv",
                        mime="text/csv",
                        type="primary",
                        use_container_width=True
                    )

    # ==========================================================================
    # ABA 5 - N√ÉO CLASSIFICADOS
    # ==========================================================================
    with tabs[5]:
        st.header("‚ö†Ô∏è Lan√ßamentos N√£o Classificados")

        if 'vps_resultado' not in st.session_state:
            st.warning("‚ö†Ô∏è Execute a concilia√ß√£o primeiro")
        else:
            df_resultado = st.session_state['vps_resultado']

            # Filtra n√£o classificados
            if 'STATUS' in df_resultado.columns:
                df_nao_class = df_resultado[df_resultado['STATUS'] == 'NAO_CLASSIFICADO'].copy()
            else:
                df_nao_class = pd.DataFrame()

            if len(df_nao_class) == 0:
                st.success("‚úÖ N√£o h√° lan√ßamentos n√£o classificados!")
            else:
                st.error(f"‚ùå {len(df_nao_class)} lan√ßamentos n√£o foram classificados")

                st.markdown("""
                **A√ß√µes necess√°rias:**
                1. Identifique os fornecedores/hist√≥ricos n√£o cadastrados abaixo
                2. Adicione-os na planilha de Contas Cont√°beis
                3. Fa√ßa upload novamente e refa√ßa a concilia√ß√£o
                """)

                st.divider()

                # Lista de n√£o classificados
                st.subheader("üìã Detalhes dos N√£o Classificados")
                st.dataframe(df_nao_class, use_container_width=True, height=400)

                # Download CSV com n√£o classificados
                csv_buffer = io.StringIO()
                df_nao_class.to_csv(csv_buffer, index=False, sep=';', encoding='utf-8-sig')
                csv_data = csv_buffer.getvalue()

                st.download_button(
                    label="üì• Baixar Lista de N√£o Classificados",
                    data=csv_data,
                    file_name=f"vps_nao_classificados_{pd.Timestamp.now().strftime('%Y%m%d_%H%M%S')}.csv",
                    mime="text/csv"
                )


if __name__ == "__main__":
    mostrar_pagina_vps()
